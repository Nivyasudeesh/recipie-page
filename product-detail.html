<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipe Detail</title>
  <link rel="stylesheet" href="product.css">
</head>

<body>

  <!-- ‚úÖ NAVBAR -->
  <nav class="navbar">
    <div class="logo">üç≤ Recipe Finder</div>
    <button onclick="window.history.back()" class="back-btn">‚¨Ö Back</button>
  </nav>

  <!-- ‚úÖ RECIPE DETAIL SECTION -->
  <div class="container">
  <div id="recipe-detail" class="recipe-detail"></div>

  <!-- Controls -->
  <div class="speech-controls" style="display:none;">
    <button id="readBtn" class="speaker-btn">üîä Read</button>
    <button id="stopBtn" class="speaker-btn">‚èπ Stop</button>
  </div>
     
  <!-- ‚≠ê REVIEW SECTION -->
<div class="review-section">
  <h3>Leave a Review</h3>

  <input type="text" id="reviewerName" placeholder="Your Name">

  <select id="rating">
    <option value="5">5 ‚≠ê</option>
    <option value="4">4 ‚≠ê</option>
    <option value="3">3 ‚≠ê</option>
    <option value="2">2 ‚≠ê</option>
    <option value="1">1 ‚≠ê</option>
  </select>

  <textarea id="reviewText" placeholder="Write your review..."></textarea>

  <button onclick="addReview()">Submit Review</button>

  <h3>User Reviews</h3>
  <div id="reviewsContainer"></div>
</div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const recipeName = params.get('name');

const detailDiv = document.getElementById("recipe-detail");
const readBtn = document.getElementById("readBtn");
const stopBtn = document.getElementById("stopBtn");
const speechControls = document.querySelector(".speech-controls");

let instructionsText = ""; // full instructions
let utterance;
let lines = [];
let currentLine = 0;

function highlightLine(lineIndex) {
  const paragraphs = detailDiv.querySelectorAll(".instruction-line");
  paragraphs.forEach((p, idx) => {
    p.style.background = idx === lineIndex ? "#fffa8b" : "transparent";
  });
}

if (!recipeName) {
  detailDiv.innerHTML = "<p>No recipe selected!</p>";
} else {
  fetch(`https://www.themealdb.com/api/json/v1/1/search.php?s=${recipeName}`)
    .then(res => res.json())
    .then(data => {
      const meal = data.meals[0];
      if (!meal) { detailDiv.innerHTML = "<p>Recipe not found!</p>"; return; }

      let ingredients = "";
      for (let i=1;i<=20;i++){
        const ingredient = meal[`strIngredient${i}`];
        const measure = meal[`strMeasure${i}`];
        if (ingredient && ingredient.trim() !== "") ingredients += `<li>${ingredient} - ${measure}</li>`;
      }

      instructionsText = meal.strInstructions;

      // Split instructions into lines for highlighting
      lines = instructionsText.split(/\. |\n/).filter(line => line.trim() !== "");
      const instructionHTML = lines.map(line => `<p class="instruction-line">${line}.</p>`).join("");

      detailDiv.innerHTML = `
        <h2>${meal.strMeal}</h2>
        <p><strong>Category:</strong> ${meal.strCategory}</p>
        <img src="${meal.strMealThumb}" alt="${meal.strMeal}" class="recipe-img"/>
        <h3>Ingredients:</h3>
        <ul>${ingredients}</ul>
        <h3>Instructions:</h3>
        ${instructionHTML}
      `;

      speechControls.style.display = "inline-block"; // show controls
    })
    .catch(() => { detailDiv.innerHTML = "<p>Error loading recipe details!</p>"; });
}

// ‚úÖ Read Instructions
readBtn.addEventListener("click", () => {
  if ('speechSynthesis' in window) {
    if (speechSynthesis.speaking) return; // prevent multiple utterances
    currentLine = 0;

    function speakNextLine() {
      if (currentLine >= lines.length) return;
      utterance = new SpeechSynthesisUtterance(lines[currentLine]);
      utterance.rate = 1;
      utterance.pitch = 1;
      utterance.onstart = () => highlightLine(currentLine);
      utterance.onend = () => {
        currentLine++;
        speakNextLine();
      };
      window.speechSynthesis.speak(utterance);
    }

    speakNextLine();
  } else {
    alert("Your browser does not support text-to-speech.");
  }
});

// ‚úÖ Stop Instructions
stopBtn.addEventListener("click", () => {
  window.speechSynthesis.cancel();
  highlightLine(-1); // remove highlight
});

//  Load reviews when page loads
document.addEventListener("DOMContentLoaded", loadReviews);

function addReview() {
  const name = document.getElementById("reviewerName").value.trim();
  const rating = document.getElementById("rating").value;
  const text = document.getElementById("reviewText").value.trim();

  if (!name || !text) {
    alert("Please fill all fields!");
    return;
  }

  const key = "reviews_" + recipeName;

  const review = { name, rating, text };

  let reviews = JSON.parse(localStorage.getItem(key)) || [];
  reviews.push(review);
  localStorage.setItem(key, JSON.stringify(reviews));

 function showToast() {
  const toast = document.getElementById("toast");
  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

  document.getElementById("reviewerName").value = "";
  document.getElementById("reviewText").value = "";

  loadReviews();
}

function loadReviews() {
  const container = document.getElementById("reviewsContainer");
  if (!container || !recipeName) return;

  const key = "reviews_" + recipeName;
  let reviews = JSON.parse(localStorage.getItem(key)) || [];

  container.innerHTML = "";

  reviews.forEach(r => {
    container.innerHTML += `
      <div class="review-card">
        <strong>${r.name}</strong> - ${r.rating} ‚≠ê
        <p>${r.text}</p>
      </div>
    `;
  });
}
</script>
<div id="toast" class="toast">Review Submitted Successfully!</div>
</body>

</html>